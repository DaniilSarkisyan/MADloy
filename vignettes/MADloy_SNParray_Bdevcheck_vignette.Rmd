---
title: "`MADloy`: Using `Bdevcheck`"
subtitle: "Marcos Lopez-Sanchez and Juan R. Gonzalez"
author: |
  | Institute for Global Health (ISGlobal), Barcelona, Spain
  | Bioinformatics Research Group in Epidemiolgy (BRGE)
  | (<http://www.creal.cat/brge.htm>)
date: "`r format(Sys.Date(), '%d %B %Y')`"
package: "`r paste('MADloy', packageVersion('MADloy'))`"
output:    
  BiocStyle::html_document:
    number_sections: true
    toc: yes
    fig_caption: yes
    fig_height: 4.5
    fig_width: 6
vignette: >
  %\VignetteIndexEntry{`MADloy`: Using `Bdevcheck`}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = "images/")

```

## Setting up

Starting from the analysis of the TCGA PRAD dataset, we applied the checkBAF method in order to improve the detection of partial losses in chrY.

```{r setting, echo=FALSE}

library(MADloy)
library(gplots)

```

## Analysis

The analysis steps are the same as before:

```{r setup, eval=FALSE}

files <- list.files("rawData", full.names=T)
res <- madloy(files, LRRCol = 5, BAFCol = 4, trim=0.1, mc.cores=10)
save(res, file="PRADres.rda")

```

```{r loadres, echo=FALSE}

data(PRADres)

```

```{r plot_res, echo=FALSE}

plot(PRADres)

```

```{r getloy, eval=TRUE}

PRADresloy <- getLOY(PRADres, offset = 0.46, pval.sig = 0.05/1038)
data.table(sample=names(PRADresloy$class[PRADresloy$class != "normal"]), class=PRADresloy$class[PRADresloy$class != "normal"], prob=PRADresloy$prob[PRADresloy$class != "normal"])

```


```{r plot_resloy, echo=FALSE}

plot(PRADresloy)

```

## Checking Bdev and LRR imbalance

In order to check that possible gains or losses of chrY (p.val < 0.05) affected only an arm or a region, a new step was added to the analysis. In this step the ploidy for all the probes in the p arm was compared against the q arm. Ploidy values were used instead of LRR because LRR does not follow a linear function, and hence, the deviation will not be equal. Trimmed mean ploidy values, deviations and number of probes for each arm were compared using a two-sample t-test, taking the code from the following link: [https://stats.stackexchange.com/questions/30394/how-to-perform-two-sample-t-tests-in-r-by-inputting-sample-statistics-rather-tha]{https://stats.stackexchange.com/questions/30394/how-to-perform-two-sample-t-tests-in-r-by-inputting-sample-statistics-rather-tha}

```{r checkBdev, eval=FALSE}

resBdev <- checkBdev(PRADresloy, LRRCol = 5, BAFCol = 4, mc.cores=10)
save(resBdev, file="PRADresBdev.rda")

```

```{r loadresBdev, echo=FALSE}

data(PRADresBdev)

```

After performing the `checkBdev` we obtained two classifications of the samples, one using the nominal p-value "nominal_p" and another using the adjusted p-value "adjusted-p". The main difference between the samples is the fact that "adjusted_p" p-value takes into account the sample size (0.05/n) to call a significant unbalance between p and q arms, while "nominal-p" does not (0.05).

```{r, echo=FALSE}

plot(unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "p")))$Pl), pch=20, ylab="Ploidy", main="Ploidy in p and q arms", xlab="sample")
lines(unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "p")))$Plsd))
points(unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "q")))$Pl), pch=20, col="red")
lines(unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "q")))$Plsd), col="red")
legend("topright", legend = c("p trimmed mean ploidy", "p ploidy standard deviation", "q trimmed mean ploidy", "q ploidy standard deviation"), pch = c(20, NA, 20, NA), lty = c(NA, 2, NA, 2), col=c("red", "red", "black", "black"))

```

```{r checkBdevresult}

check <- PRADresBdev$class[PRADresBdev$class$adjusted_p != "balancedpq" | PRADresBdev$class$nominal_p != "balancedpq", ]
check

```


The ploidy plot with the "unbalanced" tag from the "adjusted-p" samples is the following one. Filled points means a p.value below 0.05/n and empty points means a p.value below 0.05. 

```{r, echo=FALSE}
sel <- PRADresBdev$class$adjusted_p != "balancedpq" | PRADresBdev$class$nominal_p != "balancedpq"
filled <- rep(1, sum(sel))
filled[(PRADresBdev$class$adjusted_p != "balancedpq")[sel]] <- 20

plotCI(x = unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "p")))$Pl[sel]), uiw = unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "p")))$Plsd[sel]), lty = 2, xaxt ="n", pch=filled, gap = 0, ylim=c(0, 3), minbar = 0, maxbar = 3, main="Ploidy trimmed mean and deviation in p and q arms", ylab="Ploidy", xlab="getLOY classification")
par(new=TRUE)
plotCI(x = unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "q")))$Pl[sel]), uiw = unlist(data.frame(t(sapply( PRADresBdev$Bdev, "[[", "q")))$Plsd[sel]), lty = 2, xaxt ="n", pch=filled, gap = 0, ylim=c(0, 3), minbar = 0, maxbar = 3, col="red", ylab="", xlab="")

axis(1, at=c(1:sum(sel)), labels=FALSE)
text(x=c(1:sum(sel)), y=par()$usr[3]-0.125,labels=PRADresBdev$class$orig[sel], srt=45, adj=1, xpd=TRUE, cex=0.75)

legend("topright", legend = c("p arm adjusted-p", "p arm only nominal-p", "q arm adjusted-p", "q arm only nominal-p"), pch = c(20, 1, 20, 1), col=c("black", "black", "red", "red"))
```

## Visual inspection of the detected imbalances

The following plots were generated with the newly implemented `plotIndSNP` and the old function was renamed to `plotIndLRR`. The green box indicates the MSY region, while the blue boxes are the PAR1 and PAR2 regions (In those plots only PAR1 is visible). As can be seen, there are no shared probes with chrX in PAR1, and the ones in the X/Y transposed (Between blue and green boxes) are not heterozygous as they should be.

```{r echo=FALSE, eval=FALSE}

samples <- gsub(".txt", "", rownames(check))

for (i in samples){
  png(paste0("vignetteplots/", i, ".png"))
  plotIndSNP(PRADres, i, LRRCol = 5, BAFCol = 4, offset=0.46)  
  dev.off()
}


```


### Normal classified samples with disagreement between "adjusted-p"" and "nominal-p".

```{r echo=FALSE, results = 'asis'}

samples <- gsub(".txt", "", rownames(check[check$orig == "normal" & check$adjusted_p == "balancedpq", ]))

for (i in samples){
  path <- paste0(system.file("extdata", "vignetteplots", package = "MADloy"), "/", i, ".png")
  cat('\n![',i,'](',path, ')\n')
}

```

It seems that those samples are false positives

### Normal classified samples with agreement in unbalance.

```{r echo=FALSE, results = 'asis'}

samples <- gsub(".txt", "", rownames(check[check$orig == "normal" & check$adjusted_p == "unbalancedpq", ]))

for (i in samples){
  path <- paste0(system.file("extdata", "vignetteplots", package = "MADloy"), "/", i, ".png")
  cat('\n![',i,'](',path, ')\n')
}

```

Those samples seems to have a small visible unbalance between the p and q arms, indicating either a low-clonality mosaic gain or loss of one of the arms, and were not called by the `getLOY` algorithm.

### LOY classified samples with disagreement between "adjusted-p" and "nominal-p".

```{r echo=FALSE, results = 'asis'}

samples <- gsub(".txt", "", rownames(check[check$orig == "LOY" & check$adjusted_p == "balancedpq", ]))

for (i in samples){
  path <- paste0(system.file("extdata", "vignetteplots", package = "MADloy"), "/", i, ".png")
  cat('\n![',i,'](',path, ')\n')
}

```

The only sample that really seems unbalanced is the last one `TCGA-ZG-A9LM-01A` with an interstitial deletion of the p-centromere region.

### LOY classified samples with unbalanced "adjusted-p" but unclear loss.

```{r echo=FALSE, results = 'asis'}

samples <- gsub(".txt", "", rownames(check[check$orig == "LOY" & check$adjusted_p == "unbalancedpq", ]))

for (i in samples){
  path <- paste0(system.file("extdata", "vignetteplots", package = "MADloy"), "/", i, ".png")
  cat('\n![',i,'](',path, ')\n')
}

```

This sample has not been classified as p or q loss, but both thresholds classify it as unbalanced. It seems that there is a very small decrease of q arm compared to the p arm.

### LOY samples with detected losses in q arm.

```{r echo=FALSE, results = 'asis'}

samples <- gsub(".txt", "", rownames(check[check$orig == "LOY" & check$adjusted_p == "LOYq", ]))

for (i in samples){
  path <- paste0(system.file("extdata", "vignetteplots", package = "MADloy"), "/", i, ".png")
  cat('\n![',i,'](',path, ')\n')
}

```

All of the samples classified have a terminal deletion of the q arm, with varying sizes.

### XYY samples with disagreement between "adjusted-p" and "nominal-p"

```{r echo=FALSE, results = 'asis'}

samples <- gsub(".txt", "", rownames(check[check$orig == "XYY" & check$adjusted_p == "balancedpq", ]))

for (i in samples){
  path <- paste0(system.file("extdata", "vignetteplots", package = "MADloy"), "/", i, ".png")
  cat('\n![',i,'](',path, ')\n')
}

```

These samples have very sparse values, both LRR and BAF, and it seems that the imbalance is caused by this bias.

## Conclusions

It seems that we must only consider those events that have significant adjusted p-value for the t-test applied to the ploidy values. Only considering those, the number of unbalanced events is 14, nine of them beign a LOYq and 4 previously classified as "normal" but with a small imbalance between the two arms. One of the LOY events also have a small imbalance but it cannot be clearly determined where the arm loss is.
